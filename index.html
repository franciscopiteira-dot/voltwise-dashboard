<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voltwise — Dashboard</title>

  <style>
    :root{
      --bg: #f5f7fb;
      --card: #ffffff;
      --muted: #64748b;
      --text: #0f172a;
      --line: #e5e7eb;

      --good: #16a34a;
      --bad: #ef4444;
      --warn: #f59e0b;

      --shadow2: 0 6px 16px rgba(15,23,42,0.08);
      --radius: 16px;
    }

    * { box-sizing: border-box; }

    body{
      margin:0;
      background: linear-gradient(180deg, #f6f9ff 0%, #ffffff 60%);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    /* ===== TOPBAR ===== */
    header.topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(246,249,255,0.75);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }

    .topbarInner{
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      flex-wrap: wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 260px;
    }

    .logo{
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      color: white;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      box-shadow: 0 10px 20px rgba(37,99,235,0.25);
      user-select: none;
    }

    .brandText{ display:flex; flex-direction:column; gap: 2px; }
    .brandRow{ display:flex; align-items:center; gap: 10px; }
    .brandRow h1{
      font-size: 20px;
      font-weight: 900;
      margin: 0;
      letter-spacing: -0.4px;
    }

    .badge{
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(37,99,235,0.20);
      background: rgba(37,99,235,0.08);
      color: #1d4ed8;
      font-weight: 800;
    }

    .subtitle{
      font-size: 12.5px;
      color: var(--muted);
      font-weight: 700;
    }

    .topMid{
      flex:1;
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 280px;
      justify-content: center;
    }

    .searchWrap{
      flex: 1;
      max-width: 520px;
      position: relative;
    }

    .searchWrap input{
      width: 100%;
      padding: 10px 12px 10px 38px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.9);
      outline: none;
      box-shadow: 0 2px 10px rgba(15,23,42,0.04);
      font-weight: 800;
    }
    .searchWrap input::placeholder{ color:#94a3b8; }

    .searchIcon{
      position:absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      opacity: .55;
      color: #334155;
    }

    .segTabs{
      display:flex;
      align-items:center;
      gap: 6px;
      padding: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.85);
      border: 1px solid var(--line);
      box-shadow: 0 10px 25px rgba(15,23,42,0.06);
      backdrop-filter: blur(10px);
      white-space: nowrap;
    }

    .segBtn{
      appearance:none;
      border: none;
      background: transparent;
      color: #0f172a;
      font-weight: 900;
      font-size: 13px;
      padding: 10px 16px;
      border-radius: 999px;
      cursor: pointer;
      transition: background .15s ease, box-shadow .15s ease, transform .05s ease, color .15s ease;
    }

    .segBtn:hover{ background: rgba(37,99,235,0.06); }

    .segBtn.active{
      background: #ffffff;
      box-shadow: 0 6px 18px rgba(15,23,42,0.10);
      border: 1px solid rgba(37,99,235,0.18);
      color: #1d4ed8;
    }

    .segBtn:active{ transform: translateY(1px); }

    .topRight{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
      min-width: 320px;
    }

    .pill{
      padding: 6px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      font-size: 12px;
      color: #334155;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 2px 10px rgba(15,23,42,0.04);
      font-weight: 900;
    }

    .status{
      display:flex;
      align-items:center;
      gap: 8px;
      font-size: 12px;
      color: #475569;
      font-weight: 900;
    }

    .status-dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display:inline-block;
      background: var(--bad);
      box-shadow: 0 0 0 4px rgba(239,68,68,0.12);
    }

    button{
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: white;
      color: #0f172a;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 2px 10px rgba(15,23,42,0.03);
    }

    button.primary{
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      border: none;
      color: white;
      box-shadow: 0 10px 25px rgba(37,99,235,0.20);
    }

    button:active{ transform: translateY(1px); }

    button.danger{
      background: #fff1f2;
      border-color: #fecdd3;
      color: #9f1239;
      box-shadow: none;
    }

    .avatar{
      width: 38px;
      height: 38px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      font-size: 12px;
      color: #0f172a;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.9);
      box-shadow: 0 8px 20px rgba(15,23,42,0.06);
      user-select: none;
    }

    @media (max-width: 980px){
      .topbarInner{ justify-content: center; }
      .topMid{ justify-content: center; }
      .topRight{ justify-content: center; }
    }

    @media (max-width: 520px){
      .segTabs{ width: 100%; justify-content: space-between; }
      .segBtn{ flex:1; text-align:center; padding: 10px 10px; }
      .searchWrap{ max-width: 100%; }
    }

    /* ===== MAIN ===== */
    main{
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow2);
    }

    .card h2{
      font-size: 14px;
      margin: 0 0 10px;
      color: #0f172a;
      font-weight: 900;
      letter-spacing: -0.1px;
    }

    .muted{ color: var(--muted); font-size: 12px; font-weight: 800; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 8px 0 6px;
      font-weight: 900;
    }

    input, select{
      width: 100%;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #ffffff;
      color: var(--text);
      outline: none;
      font-weight: 800;
    }

    input::placeholder{ color: #9aa3af; }

    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: #fff;
    }

    th, td{
      padding: 10px;
      border-bottom: 1px solid var(--line);
      font-size: 12px;
      vertical-align: top;
      white-space: nowrap;
    }

    th{
      text-align:left;
      color: #475569;
      background: #f8fafc;
      font-weight: 900;
    }

    tr:last-child td{ border-bottom: none; }
    .small{ font-size: 11px; color: var(--muted); font-weight: 900; }

    .toolbar{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      margin-top: 10px;
    }
    .toolbar .left{ display:flex; gap:10px; align-items:center; }
    .toolbar .right{ display:flex; gap:10px; align-items:center; }

    .tableWrap{
      width: 100%;
      overflow-x: auto;
      border-radius: 14px;
    }

    .tableWrap table{ min-width: 1180px; }

    .numSm{ width: 92px; min-width: 92px; }
    .numMd{ width: 110px; min-width: 110px; }

    .dtInput{
      width: 260px !important;
      min-width: 260px !important;
      font-weight: 900;
    }

    /* Toasts */
    #toasts{
      position: fixed;
      right: 14px;
      bottom: 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      z-index: 9999;
    }

    .toast{
      width: 380px;
      max-width: calc(100vw - 28px);
      background: rgba(255,255,255,0.95);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.18);
    }

    .toast .t{ font-size: 12px; color: var(--muted); font-weight: 900; }
    .toast .m{ margin-top: 6px; font-size: 13px; color: #0f172a; font-weight: 900; }

    .toast.good{ border-color: rgba(22,163,74,0.28); }
    .toast.warn{ border-color: rgba(245,158,11,0.28); }
    .toast.bad{  border-color: rgba(239,68,68,0.28); }

    .hiddenRow { display: none !important; }

    #tblRoutes th:nth-child(2),
    #tblRoutes td:nth-child(2){
      min-width: 80px;
    }

    /* ===== OPERAÇÃO (layout) ===== */
    .opsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      align-items:start;
    }

    .opsTopRow{
      grid-column: 1 / -1;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .opsBottomLeft{ grid-column: 1; }
    .opsBottomRight{ grid-column: 2; }

    @media (max-width: 980px){
      .opsGrid{ grid-template-columns: 1fr; }
      .opsTopRow{ grid-template-columns: 1fr; }
      .opsBottomLeft, .opsBottomRight{ grid-column: 1; }
    }

    /* ===== Pills / mini-cards ===== */
    .statusChip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(22,163,74,0.28);
      background: rgba(22,163,74,0.06);
      font-weight: 900;
      font-size: 12px;
      color: #166534;
      box-shadow: 0 2px 10px rgba(15,23,42,0.04);
      white-space: nowrap;
    }
    .statusChip.warn{
      border-color: rgba(245,158,11,0.40);
      background: rgba(245,158,11,0.10);
      color: #92400e;
    }
    .statusChip .dot{
      width: 9px; height: 9px; border-radius: 999px;
      background: var(--good);
      box-shadow: 0 0 0 4px rgba(22,163,74,0.12);
    }
    .statusChip.warn .dot{
      background: var(--warn);
      box-shadow: 0 0 0 4px rgba(245,158,11,0.14);
    }

    .miniGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 10px;
    }
    @media (max-width: 980px){
      .miniGrid{ grid-template-columns: 1fr 1fr; }
    }

    .miniCard{
      border: 1px solid #e6eaf2;
      background: #f8fafc;
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 6px 16px rgba(15,23,42,0.05);
    }
    .miniCard.danger{
      border-color: rgba(239,68,68,0.35);
      background: rgba(239,68,68,0.08);
    }
    .miniLabel{
      font-size: 12px;
      color: #334155;
      font-weight: 900;
      margin-bottom: 6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .miniValue{
      font-size: 22px;
      font-weight: 1000;
      letter-spacing: -0.6px;
    }
    .miniSubWarn{
      margin-top: 6px;
      font-size: 11px;
      font-weight: 900;
      color: #9f1239;
      display:none;
    }
    .miniCard.danger .miniSubWarn{ display:block; }

    .planGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }

    /* KPIs “Resultados” com arcos (cores intensas) */
    .kpiRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
      margin-bottom: 12px;
    }
    @media (max-width: 980px){
      .kpiRow{ grid-template-columns: 1fr; }
    }

    .kpiCard{
      position: relative;
      border: 1px solid #e6eaf2;
      border-radius: 14px;
      padding: 12px;
      background: #fff;
      box-shadow: 0 6px 16px rgba(15,23,42,0.05);
      overflow:hidden;
      min-height: 88px;
    }

    .kpiCard::before{
      content:"";
      position:absolute;
      right:-34px;
      top:-34px;
      width: 140px;
      height: 140px;
      border-radius: 999px;
      pointer-events:none;
      opacity: .88;
      filter: saturate(1.25) contrast(1.05);
    }

    .kpiCard.kpiBlue{
      background: linear-gradient(180deg, rgba(37,99,235,0.06), rgba(255,255,255,1) 60%);
    }
    .kpiCard.kpiGold{
      background: linear-gradient(180deg, rgba(245,158,11,0.06), rgba(255,255,255,1) 60%);
    }
    .kpiCard.kpiAmber{
      background: linear-gradient(180deg, rgba(245,158,11,0.07), rgba(255,255,255,1) 60%);
    }

    .kpiCard.kpiBlue::before{
      background: radial-gradient(circle at 30% 30%, rgba(37,99,235,0.45), rgba(37,99,235,0) 67%);
    }
    .kpiCard.kpiGold::before{
      background: radial-gradient(circle at 30% 30%, rgba(245,158,11,0.42), rgba(245,158,11,0) 67%);
    }
    .kpiCard.kpiAmber::before{
      background: radial-gradient(circle at 30% 30%, rgba(245,158,11,0.40), rgba(245,158,11,0) 67%);
    }

    .kpiTitle{
      font-size: 12px;
      color: #475569;
      font-weight: 900;
      margin-bottom: 6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .kpiValue{
      font-size: 22px;
      font-weight: 1000;
      letter-spacing: -0.6px;
      margin-bottom: 10px;
    }

    .kpiPillSm{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 18px;
      padding: 0 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.45);
      background: rgba(241,245,249,0.95);
      color: #475569;
      font-size: 11px;
      font-weight: 900;
      width: 64px;
    }

    .kpiIcon{
      width: 34px;
      height: 34px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      border: 1px solid rgba(148,163,184,0.45);
      background: rgba(241,245,249,0.95);
    }
    .kpiIcon svg{ width: 18px; height: 18px; opacity: .9; }

    /* ====== NOVO: “Resposta completa” e “Explicações” em separadores ====== */
    .accordion{
      margin-top: 12px;
      border: 1px solid #e6eaf2;
      border-radius: 14px;
      background: #ffffff;
      box-shadow: 0 6px 16px rgba(15,23,42,0.05);
      overflow:hidden;
    }

    details.accordion > summary{
      list-style: none;
      cursor: pointer;
      padding: 12px 14px;
      font-weight: 1000;
      font-size: 13px;
      color: #0f172a;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: #f8fafc;
      border-bottom: 1px solid #e6eaf2;
    }
    details.accordion > summary::-webkit-details-marker{ display:none; }

    .accBody{
      padding: 12px 14px;
    }

    .accHint{
      font-size: 12px;
      font-weight: 900;
      color: #64748b;
      margin-bottom: 10px;
    }

    .kvGrid{
      display:grid;
      grid-template-columns: 220px 1fr;
      gap: 8px 12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .kvGrid{ grid-template-columns: 1fr; }
    }

    .kvKey{
      font-size: 12px;
      color: #475569;
      font-weight: 1000;
    }
    .kvVal{
      font-size: 12px;
      color: #0f172a;
      font-weight: 900;
      word-break: break-word;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.45);
      background: rgba(241,245,249,0.95);
      font-size: 11px;
      font-weight: 1000;
      color: #334155;
      margin-right: 8px;
      margin-bottom: 8px;
      white-space: nowrap;
    }

    .subDetails{
      border: 1px solid #e6eaf2;
      border-radius: 12px;
      background: #fff;
      overflow:hidden;
      margin-top: 10px;
    }

    .subDetails > summary{
      list-style:none;
      cursor:pointer;
      padding: 10px 12px;
      font-weight: 1000;
      font-size: 12.5px;
      background: rgba(248,250,252,0.9);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid #e6eaf2;
    }
    .subDetails > summary::-webkit-details-marker{ display:none; }

    .scrollBox{
      max-height: 260px; /* ✅ não estica a página */
      overflow:auto;
      padding-right: 6px;
    }

    /* Usar melhor o espaço: meter “Resultados” compacto e “Resposta/Explicações” no lado esquerdo */
    .opsBottomLeft .tableWrap table{ min-width: 980px; } /* menos largo para caber melhor */
    .opsBottomRight .tableWrap table{ min-width: 880px; }

  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <div class="logo">V</div>
        <div class="brandText">
          <div class="brandRow">
            <h1>Voltwise</h1>
            <span class="badge">Dashboard</span>
          </div>
          <div class="subtitle">Plataforma inteligente para frotas elétricas</div>
        </div>
      </div>

      <div class="topMid">
        <div class="searchWrap">
          <svg class="searchIcon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M10.5 18.5a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z" stroke="currentColor" stroke-width="2" opacity="0.7"/>
            <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity="0.7"/>
          </svg>
          <input id="searchInput" placeholder="Pesquisar (veículo, carregador, rota)…" />
        </div>

        <div class="segTabs" aria-label="Navegação">
          <button id="tabConfig" class="segBtn active" type="button">Configuração</button>
          <button id="tabOps" class="segBtn" type="button">Operação</button>
        </div>
      </div>

      <div class="topRight">
        <div class="status">
          <span id="apiDot" class="status-dot"></span>
          <span id="apiStatus">API: a verificar…</span>
        </div>

        <div class="pill" id="pricePill" title="Preço atual do mercado">Preço agora: —</div>

        <button id="btnPing" type="button">Testar API</button>
        <button id="btnGenerate" class="primary" type="button">Gerar Plano</button>

        <div class="avatar" title="Admin">VW</div>
      </div>
    </div>
  </header>

  <main>
    <!-- TAB: CONFIGURAÇÃO -->
    <div id="viewConfig" style="display:block;">
      <div style="display:grid; grid-template-columns: 1.65fr 0.35fr; gap:14px; align-items:start;">
        <section class="card">
          <h2>Configuração</h2>

          <div class="grid">
            <div>
              <label>Potência máxima do edifício (kW)</label>
              <input id="siteMaxKw" type="number" value="60" step="1" />
            </div>
            <div>
              <label>(opcional)</label>
              <input id="nowOverride" placeholder="YYYY-MM-DDTHH:MM:SS (Deixar vazio para automático)" />
            </div>
          </div>

          <div class="toolbar">
            <div class="left">
              <h2 style="margin:0;">Carregadores</h2>
            </div>
            <div class="right">
              <button id="btnAddCharger" type="button">+ Adicionar carregador</button>
            </div>
          </div>

          <div class="tableWrap">
            <table id="tblChargers">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Max kW</th>
                  <th>Ativo</th>
                  <th>Eficiência</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="toolbar">
            <div class="left">
              <h2 style="margin:0;">Veículos</h2>
            </div>
            <div class="right">
              <button id="btnAddVehicle" type="button">+ Adicionar veículo</button>
            </div>
          </div>

          <div class="tableWrap">
            <table id="tblVehicles">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Bateria (kWh)</th>
                  <th>SoC</th>
                  <th>SoH</th>
                  <th>Temp</th>
                  <th>Estado</th>
                  <th>Carregador (opcional)</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="toolbar">
            <div class="left">
              <h2 style="margin:0;">Preço da energia</h2>
            </div>
            <div class="right">
              <button id="btnAddPrice" type="button">+ Adicionar preço</button>
            </div>
          </div>

          <div class="tableWrap">
            <table id="tblPrices">
              <thead>
                <tr>
                  <th>Timestamp</th>
                  <th>€/kWh</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <section class="card">
          <h2>Estado do Sistema</h2>
          <div class="muted">Liga o WebSocket para pop-ups em tempo real.</div>

          <div class="toolbar" style="margin-top:12px;">
            <div class="left">
              <span class="muted">Ligação</span>
            </div>
            <div class="right">
              <button id="btnWs" type="button">Ligar pop-ups</button>
            </div>
          </div>

          <label style="margin-top:12px;">Últimos pop-ups</label>
          <div class="accordion" style="padding:0;">
            <div class="accBody scrollBox" style="max-height: 380px;">
              <div id="popupLog" class="muted" style="white-space:pre-wrap; font-weight:900;">[]</div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- TAB: OPERAÇÃO -->
    <div id="viewOps" style="display:none;">
      <div class="opsGrid">

        <div class="opsTopRow">
          <section class="card">
            <div class="toolbar" style="margin-top:0;">
              <div class="left" style="gap:8px;">
                <h2 style="margin:0;">Fleet Overview</h2>
                <span class="small">Ativos / a carregar / em rota / críticos (resumo rápido).</span>
              </div>
              <div class="right">
                <span id="fleetChip" class="statusChip"><span class="dot"></span><span id="fleetStateText">Estado: OK</span></span>
              </div>
            </div>

            <div class="miniGrid">
              <div class="miniCard">
                <div class="miniLabel">Ativos</div>
                <div class="miniValue" id="kpiActive">0</div>
              </div>
              <div class="miniCard">
                <div class="miniLabel">A carregar</div>
                <div class="miniValue" id="kpiCharging">0</div>
              </div>
              <div class="miniCard">
                <div class="miniLabel">Em rota</div>
                <div class="miniValue" id="kpiOnRoute">0</div>
              </div>
              <div class="miniCard">
                <div class="miniLabel">Críticos</div>
                <div class="miniValue" id="kpiCritical">0</div>
              </div>
            </div>
          </section>

          <section class="card">
            <h2>Saúde do Plano</h2>
            <div class="muted">Alertas + potência vs limite do edifício.</div>

            <div class="planGrid">
              <div class="miniCard">
                <div class="miniLabel">Alertas totais</div>
                <div class="miniValue" id="kpiAlertsTop">0</div>
              </div>

              <!-- ✅ aqui fica vermelho ao chegar a 80% -->
              <div class="miniCard" id="powerLimitCard">
                <div class="miniLabel">
                  <span>Potência / limite</span>
                  <span class="tag" id="powerPctTag">0%</span>
                </div>
                <div class="miniValue"><span id="kpiPowerNow">0.0</span> / <span id="kpiPowerLimit">60</span> kW</div>
                <div class="miniSubWarn" id="powerWarnTxt">Aviso: ≥ 80% do limite!</div>
              </div>
            </div>

            <div class="muted" style="margin-top:10px;">Gera um plano para atualizar indicadores.</div>
          </section>
        </div>

        <!-- ✅ ESQUERDA: Rotas + (agora) Resposta/Explicações em separadores para ocupar o espaço -->
        <section class="card opsBottomLeft">
          <h2>Operação</h2>
          <div class="muted">Rotas do dia + gerar plano.</div>

          <div class="toolbar">
            <div class="left">
              <h2 style="margin:0;">Rotas</h2>
              <span class="small">Uma rota por veículo (por agora)</span>
            </div>
            <div class="right">
              <button id="btnAddRoute" type="button">+ Adicionar rota</button>
            </div>
          </div>

          <div class="tableWrap">
            <table id="tblRoutes">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Veículo</th>
                  <th>Início</th>
                  <th>Fim</th>
                  <th>ETA (min)</th>
                  <th>Consumo (kWh)</th>
                  <th>SoC min</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- ✅ NOVO: Resposta completa por tópicos (não parece código) -->
          <details class="accordion" id="accResponse">
            <summary>
              <span>Resposta completa</span>
              <span class="muted" id="respMeta">—</span>
            </summary>
            <div class="accBody">
              <div class="accHint">Abre para ver por tópicos (comandos, alertas e resumo).</div>
              <div id="responseTopics" class="scrollBox"></div>
            </div>
          </details>

          <!-- ✅ NOVO: Explicações por veículo (botão -> veículos -> detalhes) -->
          <details class="accordion" id="accExplain">
            <summary>
              <span>Explicações por veículo</span>
              <span class="muted" id="expMeta">—</span>
            </summary>
            <div class="accBody">
              <div class="accHint">Carrega num veículo para ver a explicação (tabela).</div>
              <div id="explainAccordion" class="scrollBox"></div>
            </div>
          </details>

          <div class="toolbar" style="margin-top:12px;">
            <div class="left muted" id="hint">Gera o plano para atualizar comandos e horários.</div>
            <div class="right"></div>
          </div>
        </section>

        <!-- ✅ DIREITA: KPIs + tabela de schedule (compacto) -->
        <section class="card opsBottomRight">
          <h2>Resultados</h2>

          <div class="kpiRow">
            <div class="kpiCard kpiBlue">
              <div class="kpiTitle">
                <span>Potência total</span>
                <span class="kpiIcon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M13 2L3 14h7l-1 8 12-14h-7l-1-6Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                  </svg>
                </span>
              </div>
              <div class="kpiValue"><span id="kpiPowerCard">0.0</span></div>
              <div class="kpiPillSm">—</div>
            </div>

            <div class="kpiCard kpiGold">
              <div class="kpiTitle">
                <span>Comandos</span>
                <span class="kpiIcon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M7 4v10M17 4v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M5 14h4M15 14h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M7 20v-6M17 20v-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </span>
              </div>
              <div class="kpiValue"><span id="kpiCommandsCard">0</span></div>
              <div class="kpiPillSm">—</div>
            </div>

            <div class="kpiCard kpiAmber">
              <div class="kpiTitle">
                <span>Alertas</span>
                <span class="kpiIcon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M12 9v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M12 17h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                    <path d="M10.3 4.3 2.9 18.1A2 2 0 0 0 4.7 21h14.6a2 2 0 0 0 1.8-2.9L13.7 4.3a2 2 0 0 0-3.4 0Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                  </svg>
                </span>
              </div>
              <div class="kpiValue"><span id="kpiAlertsCard">0</span></div>
              <div class="kpiPillSm">—</div>
            </div>
          </div>

          <label style="margin-top:10px;">Plano de Carregamento (por carregador)</label>
          <div class="tableWrap">
            <table id="tblSchedule">
              <thead>
                <tr>
                  <th>Carregador</th>
                  <th>Veículo</th>
                  <th>Início</th>
                  <th>Fim (estimado)</th>
                  <th>kW</th>
                  <th>Motivo</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="muted" style="margin-top:10px;">
            As secções “Resposta completa” e “Explicações por veículo” estão do lado esquerdo para caber tudo numa página.
          </div>
        </section>

      </div>
    </div>
  </main>

  <div id="toasts"></div>

  <script>
    const API_BASE = window.location.origin;
    const WS_URL = (window.location.protocol === "https:" ? "wss://" : "ws://") + window.location.host + "/ws";

    // -------------------- State --------------------
    let chargers = [{ id: "C1", max_kw: 22, enabled: true, efficiency: 0.92 }];

    let vehicles = [
      { id: "V1", battery_kwh: 75, soc: 0.30, soh: 0.95, temp_c: 28, state: "DISPONIVEL", charger_id: "" }
    ];

    let routes = [
      { id: "R1", vehicle_id: "V1", start_time: "2026-01-23T19:00:00", end_time: "2026-01-23T20:30:00", eta_minutes: 90, consumption_kwh: 22, required_soc_min: 0.60, distance_km: 95 }
    ];

    let prices = [
      { ts: "2026-01-23T17:00:00", eur_per_kwh: 0.18 },
      { ts: "2026-01-23T18:00:00", eur_per_kwh: 0.24 },
      { ts: "2026-01-23T19:00:00", eur_per_kwh: 0.32 }
    ];

    let ws = null;
    let popupHistory = [];
    let lastPlan = null;

    // -------------------- Helpers --------------------
    const $ = (id) => document.getElementById(id);

    function nowIsoLocalNoTZ() { return new Date().toISOString().slice(0, 19); }

    function toast(msg, kind="good") {
      const host = $("toasts");
      const el = document.createElement("div");
      el.className = `toast ${kind}`;
      el.innerHTML = `<div class="t">${new Date().toLocaleTimeString()}</div><div class="m">${escapeHtml(msg)}</div>`;
      host.appendChild(el);
      setTimeout(() => { el.style.opacity = "0"; el.style.transition = "opacity .25s"; }, 4200);
      setTimeout(() => host.removeChild(el), 4600);
    }

    function escapeHtml(s) {
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }

    function setApiStatus(ok, text) {
      $("apiDot").style.background = ok ? "var(--good)" : "var(--bad)";
      $("apiDot").style.boxShadow = ok
        ? "0 0 0 4px rgba(22,163,74,0.12)"
        : "0 0 0 4px rgba(239,68,68,0.12)";
      $("apiStatus").textContent = text;
    }

    function fmtTime(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      } catch { return "—"; }
    }

    function safeNum(x, fallback=0){
      const n = Number(x);
      return Number.isFinite(n) ? n : fallback;
    }

    function isoToDatetimeLocal(iso) {
      const s = String(iso || "").trim();
      if (!s) return "";
      return s.slice(0,16);
    }

    function datetimeLocalToIso(v) {
      const s = String(v || "").trim();
      if (!s) return "";
      return (s.length === 16) ? (s + ":00") : s;
    }

    // -------------------- Tabs --------------------
    function setTab(name) {
      const isConfig = name === "config";
      $("viewConfig").style.display = isConfig ? "block" : "none";
      $("viewOps").style.display = isConfig ? "none" : "block";
      $("tabConfig").classList.toggle("active", isConfig);
      $("tabOps").classList.toggle("active", !isConfig);
      localStorage.setItem("fleet_ai_tab", isConfig ? "config" : "ops");
    }
    $("tabConfig").addEventListener("click", () => setTab("config"));
    $("tabOps").addEventListener("click", () => setTab("ops"));

    // -------------------- Render tables --------------------
    function renderChargers() {
      const tb = $("tblChargers").querySelector("tbody");
      tb.innerHTML = "";
      chargers.forEach((c, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input value="${c.id}" data-k="id" data-i="${idx}" /></td>
          <td><input class="numMd" type="number" step="1" value="${c.max_kw}" data-k="max_kw" data-i="${idx}" /></td>
          <td><input type="checkbox" ${c.enabled ? "checked":""} data-k="enabled" data-i="${idx}" /></td>
          <td><input class="numMd" type="number" step="0.01" min="0" max="1" value="${c.efficiency}" data-k="efficiency" data-i="${idx}" /></td>
          <td><button class="danger" data-del="charger" data-i="${idx}" type="button">Remover</button></td>
        `;
        tb.appendChild(tr);
      });
    }

    function renderVehicles() {
      const tb = $("tblVehicles").querySelector("tbody");
      tb.innerHTML = "";
      vehicles.forEach((v, idx) => {
        const chargerOptions = [`<option value="">(auto / nenhum)</option>`]
          .concat(chargers.map(c => `<option value="${c.id}" ${v.charger_id===c.id ? "selected":""}>${c.id}</option>`))
          .join("");

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input value="${v.id}" data-k="id" data-i="${idx}" /></td>
          <td><input class="numMd" type="number" step="1" value="${v.battery_kwh}" data-k="battery_kwh" data-i="${idx}" /></td>
          <td><input class="numMd" type="number" step="0.01" min="0" max="1" value="${v.soc}" data-k="soc" data-i="${idx}" /></td>
          <td><input class="numMd" type="number" step="0.01" min="0" max="1" value="${v.soh}" data-k="soh" data-i="${idx}" /></td>
          <td><input class="numSm" type="number" step="1" value="${v.temp_c}" data-k="temp_c" data-i="${idx}" /></td>
          <td>
            <select data-k="state" data-i="${idx}">
              <option value="DISPONIVEL" ${v.state==="DISPONIVEL"?"selected":""}>DISPONIVEL</option>
              <option value="EM_ROTA" ${v.state==="EM_ROTA"?"selected":""}>EM_ROTA</option>
              <option value="MANUTENCAO" ${v.state==="MANUTENCAO"?"selected":""}>MANUTENCAO</option>
            </select>
          </td>
          <td><select data-k="charger_id" data-i="${idx}">${chargerOptions}</select></td>
          <td><button class="danger" data-del="vehicle" data-i="${idx}" type="button">Remover</button></td>
        `;
        tb.appendChild(tr);
      });
    }

    function renderRoutes() {
      const tb = $("tblRoutes").querySelector("tbody");
      tb.innerHTML = "";
      routes.forEach((r, idx) => {
        const vehicleOptions = vehicles.map(v => `<option value="${v.id}" ${r.vehicle_id===v.id?"selected":""}>${v.id}</option>`).join("");
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input value="${r.id}" data-k="id" data-i="${idx}" /></td>
          <td><select data-k="vehicle_id" data-i="${idx}">${vehicleOptions}</select></td>
          <td><input class="dtInput" type="datetime-local" value="${isoToDatetimeLocal(r.start_time)}" data-k="start_time" data-i="${idx}" /></td>
          <td><input class="dtInput" type="datetime-local" value="${isoToDatetimeLocal(r.end_time)}" data-k="end_time" data-i="${idx}" /></td>
          <td><input class="numSm" type="number" step="1" value="${r.eta_minutes}" data-k="eta_minutes" data-i="${idx}" /></td>
          <td><input class="numMd" type="number" step="0.1" value="${r.consumption_kwh}" data-k="consumption_kwh" data-i="${idx}" /></td>
          <td><input class="numMd" type="number" step="0.01" min="0" max="1" value="${r.required_soc_min}" data-k="required_soc_min" data-i="${idx}" /></td>
          <td><button class="danger" data-del="route" data-i="${idx}" type="button">Remover</button></td>
        `;
        tb.appendChild(tr);
      });
    }

    function renderPrices() {
      const tb = $("tblPrices").querySelector("tbody");
      tb.innerHTML = "";
      prices.forEach((p, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input value="${p.ts}" data-k="ts" data-i="${idx}" /></td>
          <td><input class="numMd" type="number" step="0.001" value="${p.eur_per_kwh}" data-k="eur_per_kwh" data-i="${idx}" /></td>
          <td><button class="danger" data-del="price" data-i="${idx}" type="button">Remover</button></td>
        `;
        tb.appendChild(tr);
      });
    }

    function renderAll() {
      renderChargers();
      renderVehicles();
      renderRoutes();
      renderPrices();
      updateDashboardKpis();
    }

    // -------------------- NOVO: render “Resposta completa” por tópicos --------------------
    function makeKvGrid(obj){
      const wrap = document.createElement("div");
      wrap.className = "kvGrid";
      for (const [k, v] of Object.entries(obj || {})) {
        const kEl = document.createElement("div");
        kEl.className = "kvKey";
        kEl.textContent = k;

        const vEl = document.createElement("div");
        vEl.className = "kvVal";
        vEl.textContent = (typeof v === "object" && v !== null)
          ? JSON.stringify(v)
          : String(v);

        wrap.appendChild(kEl);
        wrap.appendChild(vEl);
      }
      return wrap;
    }

    function renderResponseTopics(plan){
      const host = $("responseTopics");
      host.innerHTML = "";

      if (!plan || Object.keys(plan).length === 0) {
        host.innerHTML = `<div class="muted" style="font-weight:900;">Sem dados ainda. Clica em “Gerar Plano”.</div>`;
        $("respMeta").textContent = "—";
        return;
      }

      const ts = plan.timestamp || plan.now || "";
      const totalKw = (plan.total_kw != null) ? safeNum(plan.total_kw, 0) : null;
      const commands = Array.isArray(plan.commands) ? plan.commands : [];
      const alerts = Array.isArray(plan.alerts) ? plan.alerts : [];

      $("respMeta").textContent = ts ? `• ${ts}` : `• ${commands.length} comandos`;

      // Tags resumo
      const tags = document.createElement("div");
      tags.innerHTML = `
        <span class="tag">Comandos: ${commands.length}</span>
        <span class="tag">Alertas: ${alerts.length}</span>
        <span class="tag">Potência: ${(totalKw==null? "—" : totalKw.toFixed(1))} kW</span>
      `;
      host.appendChild(tags);

      // Secção: Resumo (timestamp / total / etc)
      const summary = document.createElement("div");
      summary.style.marginTop = "10px";
      summary.appendChild(makeKvGrid({
        timestamp: ts || "—",
        total_kw: (totalKw==null ? "—" : totalKw.toFixed(3)),
        source: plan.source || plan.price_source || "—",
        ok: (plan.ok != null ? String(plan.ok) : "—")
      }));
      host.appendChild(summary);

      // Secção: Alertas
      const alertBox = document.createElement("div");
      alertBox.className = "subDetails";
      const alertDetails = document.createElement("details");
      alertDetails.open = (alerts.length > 0);
      alertDetails.className = "subDetails";
      alertDetails.innerHTML = `<summary>Alertas (${alerts.length}) <span class="muted">clique para abrir</span></summary>`;
      const alertBody = document.createElement("div");
      alertBody.style.padding = "10px 12px";
      if (alerts.length === 0) {
        alertBody.innerHTML = `<div class="muted" style="font-weight:900;">Sem alertas.</div>`;
      } else {
        const ul = document.createElement("ul");
        ul.style.margin = "0";
        ul.style.paddingLeft = "18px";
        ul.style.fontSize = "12px";
        ul.style.fontWeight = "900";
        ul.style.color = "#0f172a";
        alerts.forEach(a => {
          const li = document.createElement("li");
          li.textContent = String(a);
          ul.appendChild(li);
        });
        alertBody.appendChild(ul);
      }
      alertDetails.appendChild(alertBody);
      host.appendChild(alertDetails);

      // Secção: Comandos (tabela)
      const cmdDetails = document.createElement("details");
      cmdDetails.className = "subDetails";
      cmdDetails.open = true;
      cmdDetails.innerHTML = `<summary>Comandos (${commands.length}) <span class="muted">clique para abrir</span></summary>`;
      const cmdBody = document.createElement("div");
      cmdBody.style.padding = "10px 12px";

      if (commands.length === 0) {
        cmdBody.innerHTML = `<div class="muted" style="font-weight:900;">Sem carregamentos planeados neste momento.</div>`;
      } else {
        const t = document.createElement("table");
        t.style.width = "100%";
        t.style.minWidth = "0";
        t.innerHTML = `
          <thead>
            <tr>
              <th>Veículo</th>
              <th>Carregador</th>
              <th>kW</th>
              <th>Motivo</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tb = t.querySelector("tbody");
        commands.forEach(c => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${escapeHtml(c.vehicle_id ?? "—")}</td>
            <td>${escapeHtml(c.charger_id ?? "—")}</td>
            <td>${(c.set_kw != null) ? safeNum(c.set_kw, 0).toFixed(1) : "—"}</td>
            <td style="white-space:normal;">${escapeHtml(c.reason ?? "")}</td>
          `;
          tb.appendChild(tr);
        });
        cmdBody.appendChild(t);
      }

      cmdDetails.appendChild(cmdBody);
      host.appendChild(cmdDetails);
    }

    // -------------------- NOVO: render “Explicações por veículo” (accordion) --------------------
    function renderExplainAccordion(explanations){
      const host = $("explainAccordion");
      host.innerHTML = "";

      const exp = explanations && typeof explanations === "object" ? explanations : {};
      const vids = Object.keys(exp);

      $("expMeta").textContent = vids.length ? `• ${vids.length} veículo(s)` : "—";

      if (vids.length === 0) {
        host.innerHTML = `<div class="muted" style="font-weight:900;">Sem explicações ainda. Clica em “Gerar Plano”.</div>`;
        return;
      }

      vids.sort().forEach(vid => {
        const d = document.createElement("details");
        d.className = "subDetails";
        d.innerHTML = `<summary>${escapeHtml(vid)} <span class="muted">clique para abrir</span></summary>`;
        const body = document.createElement("div");
        body.style.padding = "10px 12px";
        body.appendChild(makeKvGrid(exp[vid] || {}));
        d.appendChild(body);
        host.appendChild(d);
      });
    }

    // -------------------- KPIs + alerta 80% --------------------
    function calcCriticalCount(){
      let critical = 0;
      for (const v of vehicles){
        if (v.state === "MANUTENCAO") { critical++; continue; }
        const r = routes.find(x => x.vehicle_id === v.id);
        if (r && safeNum(v.soc) < safeNum(r.required_soc_min)) critical++;
      }
      return critical;
    }

    function updateFleetChip(ok){
      const chip = $("fleetChip");
      chip.classList.toggle("warn", !ok);
      $("fleetStateText").textContent = ok ? "Estado: OK" : "Estado: Atenção";
    }

    function updatePowerLimitVisual(totalKw, limit){
      const card = $("powerLimitCard");
      const pct = limit > 0 ? Math.round((totalKw / limit) * 100) : 0;
      $("powerPctTag").textContent = `${pct}%`;

      const warn = (limit > 0) && ((totalKw / limit) >= 0.80);
      card.classList.toggle("danger", warn);
      $("powerWarnTxt").style.display = warn ? "block" : "none";
    }

    function updateDashboardKpis(){
      const active = vehicles.length;
      const onRoute = vehicles.filter(v => v.state === "EM_ROTA").length;

      const planCommands = Array.isArray(lastPlan?.commands) ? lastPlan.commands : [];
      const vehiclesChargingByPlan = new Set(planCommands.map(c => c.vehicle_id).filter(Boolean));
      const charging = vehicles.filter(v => (v.charger_id && String(v.charger_id).trim() !== "") || vehiclesChargingByPlan.has(v.id)).length;

      const critical = calcCriticalCount();

      $("kpiActive").textContent = String(active);
      $("kpiOnRoute").textContent = String(onRoute);
      $("kpiCharging").textContent = String(charging);
      $("kpiCritical").textContent = String(critical);

      const alerts = Array.isArray(lastPlan?.alerts) ? lastPlan.alerts.length : 0;

      let totalKw = 0;
      if (lastPlan && lastPlan.total_kw != null) totalKw = safeNum(lastPlan.total_kw, 0);
      else totalKw = planCommands.reduce((acc, c) => acc + safeNum(c.set_kw, 0), 0);

      const limit = safeNum($("siteMaxKw")?.value, 60);

      $("kpiAlertsTop").textContent = String(alerts);
      $("kpiPowerNow").textContent = totalKw.toFixed(1);
      $("kpiPowerLimit").textContent = String(limit);

      updatePowerLimitVisual(totalKw, limit);

      $("kpiPowerCard").textContent = totalKw.toFixed(1);
      $("kpiCommandsCard").textContent = String(planCommands.length);
      $("kpiAlertsCard").textContent = String(alerts);

      updateFleetChip((critical === 0) && (alerts === 0));
    }

    // -------------------- Persistência --------------------
    const STORAGE_KEY = "fleet_ai_state_v1";

    function saveState() {
      const state = {
        chargers, vehicles, routes, prices,
        siteMaxKw: $("siteMaxKw")?.value ?? 60,
        nowOverride: $("nowOverride")?.value ?? ""
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      try {
        const s = JSON.parse(raw);
        chargers = s.chargers ?? chargers;
        vehicles = s.vehicles ?? vehicles;
        routes = s.routes ?? routes;
        prices = s.prices ?? prices;
        if (s.siteMaxKw != null) $("siteMaxKw").value = s.siteMaxKw;
        if (s.nowOverride != null) $("nowOverride").value = s.nowOverride;
        return true;
      } catch { return false; }
    }

    // -------------------- Interações --------------------
    document.addEventListener("input", (e) => {
      const t = e.target;
      const k = t.getAttribute("data-k");
      const i = t.getAttribute("data-i");
      if (k === null || i === null) {
        if (t.id === "siteMaxKw" || t.id === "nowOverride") {
          saveState();
          updateDashboardKpis();
        }
        return;
      }

      const table = t.closest("table")?.id;
      const idx = Number(i);

      function setObj(arr, idx, key, value) { if (arr[idx]) arr[idx][key] = value; }

      let val;
      if (t.type === "checkbox") val = t.checked;
      else if (t.type === "number") val = Number(t.value);
      else val = t.value;

      if (table === "tblRoutes" && (k === "start_time" || k === "end_time")) {
        val = datetimeLocalToIso(val);
      }

      if (table === "tblChargers") setObj(chargers, idx, k, val);
      if (table === "tblVehicles") setObj(vehicles, idx, k, val);
      if (table === "tblRoutes")   setObj(routes, idx, k, val);
      if (table === "tblPrices")   setObj(prices, idx, k, val);

      if (table === "tblChargers" || table === "tblVehicles") {
        renderVehicles();
        renderRoutes();
      }

      saveState();
      updateDashboardKpis();
      applySearchFilter(($("searchInput")?.value ?? "").trim());
    });

    document.addEventListener("click", (e) => {
      const t = e.target;
      if (!(t instanceof HTMLElement)) return;

      const del = t.getAttribute("data-del");
      const i = t.getAttribute("data-i");
      if (del && i !== null) {
        const idx = Number(i);
        if (del === "charger") chargers.splice(idx, 1);
        if (del === "vehicle") vehicles.splice(idx, 1);
        if (del === "route") routes.splice(idx, 1);
        if (del === "price") prices.splice(idx, 1);
        renderAll();
        saveState();
        applySearchFilter(($("searchInput")?.value ?? "").trim());
        return;
      }
    });

    $("btnAddCharger").addEventListener("click", () => {
      const n = chargers.length + 1;
      chargers.push({ id: `C${n}`, max_kw: 11, enabled: true, efficiency: 0.90 });
      renderAll(); saveState();
      applySearchFilter(($("searchInput")?.value ?? "").trim());
      toast("Carregador adicionado.", "good");
    });

    $("btnAddVehicle").addEventListener("click", () => {
      const n = vehicles.length + 1;
      vehicles.push({ id: `V${n}`, battery_kwh: 60, soc: 0.40, soh: 0.93, temp_c: 28, state: "DISPONIVEL", charger_id: "" });
      renderAll(); saveState();
      applySearchFilter(($("searchInput")?.value ?? "").trim());
      toast("Veículo adicionado.", "good");
    });

    $("btnAddRoute").addEventListener("click", () => {
      const n = routes.length + 1;
      const v = vehicles[0]?.id || `V1`;
      const start = new Date(Date.now() + 60*60*1000);
      const end = new Date(Date.now() + 2*60*60*1000);

      routes.push({
        id: `R${n}`,
        vehicle_id: v,
        start_time: start.toISOString().slice(0,19),
        end_time: end.toISOString().slice(0,19),
        eta_minutes: 60,
        consumption_kwh: 15,
        required_soc_min: 0.55,
        distance_km: 70
      });

      renderAll(); saveState();
      applySearchFilter(($("searchInput")?.value ?? "").trim());
      toast("Rota adicionada.", "good");
    });

    $("btnAddPrice").addEventListener("click", () => {
      prices.push({ ts: nowIsoLocalNoTZ(), eur_per_kwh: 0.20 });
      renderAll(); saveState();
      applySearchFilter(($("searchInput")?.value ?? "").trim());
      toast("Preço adicionado.", "good");
    });

    // -------------------- API --------------------
    async function pingApi() {
      try {
        const r = await fetch(`${API_BASE}/health`, { method: "GET" });
        setApiStatus(r.ok, r.ok ? "API: online" : "API: erro");
        return r.ok;
      } catch {
        setApiStatus(false, "API: offline");
        return false;
      }
    }

    async function refreshPrice() {
      const pill = $("pricePill");
      if (!pill) return;

      try {
        const r = await fetch(`${API_BASE}/price/current`, { method: "GET" });
        const data = await r.json();

        if (!data.ok || data.eur_per_kwh == null) {
          pill.textContent = "Preço agora: —";
          pill.title = data.error || "Sem preço disponível";
          pill.style.borderColor = "var(--line)";
          return;
        }

        const raw = Number(data.eur_per_kwh);
        const src = data.source || "?";

        pill.textContent = `Preço agora: €${raw.toFixed(4)}/kWh (${src})`;
        pill.title = `Valor bruto: ${raw}`;
        pill.style.borderColor = "var(--line)";
      } catch {
        pill.textContent = "Preço agora: —";
        pill.title = "Erro a obter preço";
        pill.style.borderColor = "var(--line)";
      }
    }

    $("btnPing").addEventListener("click", async () => {
      const ok = await pingApi();
      toast(ok ? "API está online." : "Não consegui ligar à API.", ok ? "good" : "bad");
    });

    function buildPayload() {
      const nowOverride = $("nowOverride").value.trim();
      const now = nowOverride ? nowOverride : nowIsoLocalNoTZ();

      return {
        now,
        site_max_kw: Number($("siteMaxKw").value),
        vehicles: vehicles.map(v => ({
          id: v.id,
          battery_kwh: Number(v.battery_kwh),
          soc: Number(v.soc),
          soh: Number(v.soh),
          temp_c: Number(v.temp_c),
          state: v.state,
          charger_id: v.charger_id ? String(v.charger_id) : null
        })),
        chargers: chargers.map(c => ({
          id: c.id,
          max_kw: Number(c.max_kw),
          enabled: Boolean(c.enabled),
          efficiency: Number(c.efficiency)
        })),
        routes: routes.map(r => ({
          id: r.id,
          vehicle_id: r.vehicle_id,
          start_time: r.start_time,
          end_time: r.end_time,
          distance_km: Number(r.distance_km ?? 0),
          eta_minutes: Number(r.eta_minutes),
          consumption_kwh: Number(r.consumption_kwh),
          required_soc_min: Number(r.required_soc_min)
        })),
        prices: prices.map(p => ({
          ts: p.ts,
          eur_per_kwh: Number(p.eur_per_kwh)
        }))
      };
    }

    function renderScheduleTable(data) {
      const table = document.querySelector("#tblSchedule tbody");
      if (!table) return;

      table.innerHTML = "";
      const nowIso = data.timestamp ?? new Date().toISOString();
      const commands = Array.isArray(data.commands) ? data.commands : [];

      if (commands.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6" class="small">Sem carregamentos planeados neste momento.</td>`;
        table.appendChild(tr);
        return;
      }

      commands.forEach((cmd) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(cmd.charger_id ?? "—")}</td>
          <td>${escapeHtml(cmd.vehicle_id ?? "—")}</td>
          <td>${fmtTime(nowIso)}</td>
          <td>—</td>
          <td>${(cmd.set_kw != null) ? safeNum(cmd.set_kw, 0).toFixed(1) : "—"}</td>
          <td style="white-space:normal;">${escapeHtml(cmd.reason ?? "")}</td>
        `;
        table.appendChild(tr);
      });
    }

    $("btnGenerate").addEventListener("click", async () => {
      const ok = await pingApi();
      if (!ok) {
        toast("API offline. Liga o backend (uvicorn).", "bad");
        return;
      }

      setTab("ops");
      const payload = buildPayload();

      try {
        const res = await fetch(`${API_BASE}/plan`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        lastPlan = data;

        renderScheduleTable(data);
        renderResponseTopics(data);
        renderExplainAccordion(data.explanations ?? {});

        updateDashboardKpis();

        toast(res.ok ? "Plano gerado com sucesso." : "Erro ao gerar plano (ver detalhes).", res.ok ? "good" : "bad");

        // abre automaticamente o resumo (resposta completa) quando há alertas
        const alerts = Array.isArray(data.alerts) ? data.alerts.length : 0;
        if (alerts > 0) $("accResponse").open = true;

      } catch (e) {
        toast("Falha de ligação ao /plan. Verifica CORS e backend.", "bad");
      }
    });

    // -------------------- WebSocket --------------------
    function connectWs() {
      if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
        toast("WebSocket já ligado.", "warn");
        return;
      }

      ws = new WebSocket(WS_URL);

      ws.onopen = () => {
        toast("Pop-ups ligados (WebSocket).", "good");
        ws._ping = setInterval(() => {
          try { ws.send("ping"); } catch {}
        }, 8000);
      };

      ws.onmessage = (ev) => {
        try {
          const msg = JSON.parse(ev.data);
          if (msg.type === "popups" && Array.isArray(msg.items)) {
            msg.items.forEach(it => toast(String(it), "warn"));
            popupHistory = popupHistory.concat(msg.items).slice(-20);
            $("popupLog").textContent = JSON.stringify(popupHistory, null, 2);
          }
        } catch {}
      };

      ws.onclose = () => {
        if (ws?._ping) clearInterval(ws._ping);
        toast("WebSocket desligado.", "warn");
      };

      ws.onerror = () => toast("Erro no WebSocket. Confirma /ws no backend.", "bad");
    }

    $("btnWs").addEventListener("click", connectWs);

    // -------------------- Pesquisa --------------------
    function applySearchFilter(qRaw) {
      const q = String(qRaw || "").trim().toLowerCase();
      const tableIds = ["tblChargers", "tblVehicles", "tblPrices", "tblRoutes", "tblSchedule"];
      for (const id of tableIds) {
        const tb = document.querySelector(`#${id} tbody`);
        if (!tb) continue;

        const rows = Array.from(tb.querySelectorAll("tr"));
        rows.forEach(row => {
          if (!q) { row.classList.remove("hiddenRow"); return; }
          const txt = row.textContent?.toLowerCase?.() ?? "";
          row.classList.toggle("hiddenRow", !txt.includes(q));
        });
      }
    }

    $("searchInput").addEventListener("input", (e) => applySearchFilter(e.target.value));
    $("searchInput").addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        e.target.value = "";
        applySearchFilter("");
      }
    });

    // -------------------- Init --------------------
    loadState();
    renderAll();
    saveState();

    const savedTab = localStorage.getItem("fleet_ai_tab");
    setTab(savedTab === "ops" ? "ops" : "config");

    pingApi();
    refreshPrice();
    setInterval(refreshPrice, 30000);

    // estado inicial (se ainda não houve plano)
    renderResponseTopics(null);
    renderExplainAccordion({});
    updateDashboardKpis();
  </script>
</body>
</html>
